<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Sensor Device Tracking</title>
    <meta name="description" content="Professional visualization for multi-sensor device tracking using distance-based lateration">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- SVG Icon Definitions -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-upload" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </symbol>
        <symbol id="icon-connect" viewBox="0 0 24 24">
            <path d="M18.36 6.64a9 9 0 1 1-12.73 0M12 2v10"/>
        </symbol>
        <symbol id="icon-disconnect" viewBox="0 0 24 24">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/>
        </symbol>
        <symbol id="icon-play" viewBox="0 0 24 24">
            <polygon points="5 3 19 12 5 21 5 3"/>
        </symbol>
        <symbol id="icon-pause" viewBox="0 0 24 24">
            <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
        </symbol>
        <symbol id="icon-prev" viewBox="0 0 24 24">
            <polygon points="19 20 9 12 19 4 19 20"/><line x1="5" y1="19" x2="5" y2="5"/>
        </symbol>
        <symbol id="icon-next" viewBox="0 0 24 24">
            <polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19"/>
        </symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </symbol>
        <symbol id="icon-import" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </symbol>
        <symbol id="icon-close" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </symbol>
        <symbol id="icon-minus" viewBox="0 0 24 24">
            <line x1="5" y1="12" x2="19" y2="12"/>
        </symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24">
            <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </symbol>
        <symbol id="icon-map-pin" viewBox="0 0 24 24">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
        </symbol>
        <symbol id="icon-server" viewBox="0 0 24 24">
            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>
        </symbol>
    </svg>

    <!-- Main Map Container -->
    <div id="map"></div>

    <!-- Control Panel -->
    <div id="control-panel" class="panel">
        <div class="panel-header">
            <h2>Sensor Tracking</h2>
            <button id="toggle-panel" class="btn-icon" title="Minimize">
                <svg class="icon"><use href="#icon-minus"/></svg>
            </button>
        </div>

        <div class="panel-content">
            <!-- File Upload Section -->
            <section class="section">
                <div class="section-title">Data Input</div>
                <div class="upload-area" id="upload-area">
                    <input type="file" id="file-input" accept=".json" hidden>
                    <label for="file-input" class="upload-label">
                        <svg class="icon" style="width:28px;height:28px;stroke:currentColor;fill:none;stroke-width:1.5">
                            <use href="#icon-upload"/>
                        </svg>
                        <span>Drop JSON file or click to upload</span>
                    </label>
                </div>
                <button id="load-sample" class="btn btn-secondary">Load Sample Data</button>
            </section>

            <!-- MQTT Live Data Section -->
            <section class="section">
                <div class="section-title">MQTT Live Data</div>
                <div class="mqtt-status" id="mqtt-status">
                    <span class="status-dot disconnected"></span>
                    <span class="status-text">Not connected</span>
                </div>
                <div class="mqtt-inputs">
                    <input type="text" id="mqtt-broker" class="input-field" placeholder="ws://broker:port/mqtt">
                    <input type="text" id="mqtt-topic" class="input-field" placeholder="Topic (e.g. sensors/#)">
                </div>
                <div class="mqtt-buttons">
                    <button id="mqtt-connect" class="btn btn-primary">Connect</button>
                    <button id="mqtt-proxy-connect" class="btn btn-success" title="Connect via local proxy">VCR Proxy</button>
                    <button id="mqtt-disconnect" class="btn btn-secondary" disabled>Disconnect</button>
                </div>
                <p class="mqtt-hint">
                    Proxy: Run <code>npm start</code> in mqtt-proxy folder first
                </p>
                <div id="mqtt-sensors-pending" class="mqtt-pending-sensors" style="display: none;">
                    <span class="pending-badge">!</span>
                    <span>New sensors need GPS</span>
                    <button id="mqtt-assign-gps" class="btn btn-small btn-primary">Assign GPS</button>
                </div>
            </section>

            <!-- Layer Controls -->
            <section class="section">
                <div class="section-title">Map Layers</div>
                <div class="toggle-group">
                    <label class="toggle">
                        <input type="checkbox" id="layer-sensors" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Sensors</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" id="layer-devices" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Devices</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" id="layer-heatmap">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Heatmap</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" id="layer-zones" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Zones</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" id="toggle-kalman" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Kalman Filter</span>
                    </label>
                    <label class="toggle">
                        <input type="checkbox" id="layer-debug">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label muted">Debug Mode</span>
                    </label>
                </div>
            </section>

            <!-- Time Controls -->
            <section class="section" id="time-section" style="display: none;">
                <div class="section-title">Time Control</div>
                <div class="time-display">
                    <span id="current-time">--:--:--</span>
                    <span id="timestamp-index">0 / 0</span>
                </div>
                <input type="range" id="time-slider" min="0" max="100" value="0" class="time-slider">
                <div class="playback-controls">
                    <button id="btn-prev" class="btn-icon" title="Previous">
                        <svg class="icon" style="stroke:currentColor;fill:currentColor;stroke-width:0"><use href="#icon-prev"/></svg>
                    </button>
                    <button id="btn-play" class="btn-icon btn-play" title="Play">
                        <svg class="icon" style="stroke:currentColor;fill:currentColor;stroke-width:0"><use href="#icon-play"/></svg>
                    </button>
                    <button id="btn-next" class="btn-icon" title="Next">
                        <svg class="icon" style="stroke:currentColor;fill:currentColor;stroke-width:0"><use href="#icon-next"/></svg>
                    </button>
                    <select id="playback-speed" class="speed-select">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="2">2x</option>
                        <option value="4">4x</option>
                    </select>
                </div>
            </section>

            <!-- Zone Management -->
            <section class="section">
                <div class="section-title">Zone Management</div>
                <div class="btn-group" style="margin-bottom:10px">
                    <button id="btn-draw-zone" class="btn btn-primary">Draw Zone</button>
                    <button id="btn-import-zone" class="btn btn-secondary">Import</button>
                    <button id="btn-export-zones" class="btn btn-secondary">Export</button>
                </div>
                <input type="file" id="zone-import-input" accept=".json,.geojson" hidden>
                <div id="zone-list" class="zone-list">
                    <p class="zone-empty">No zones defined</p>
                </div>
            </section>

            <!-- Map Style -->
            <section class="section">
                <div class="section-title">Map Style</div>
                <div class="style-buttons">
                    <button id="style-dark" class="btn btn-secondary active">Dark</button>
                    <button id="style-light" class="btn btn-secondary">Light</button>
                </div>
            </section>

            <!-- GPS Coordinate Management -->
            <section class="section">
                <div class="section-title">Sensor GPS Storage</div>
                <div class="gps-management-info" id="gps-storage-info">
                    <span id="stored-gps-count">0</span> sensors stored
                </div>
                <div class="gps-buttons">
                    <button id="btn-manage-gps" class="btn btn-primary">Edit</button>
                    <button id="btn-export-gps" class="btn btn-secondary">Export</button>
                    <button id="btn-import-gps" class="btn btn-secondary">Import</button>
                </div>
                <input type="file" id="gps-import-input" accept=".json" hidden>
            </section>
        </div>
    </div>

    <!-- Statistics Panel -->
    <div id="stats-panel" class="panel stats-panel">
        <div class="panel-header">
            <h3>Statistics</h3>
        </div>
        <div class="stats-content">
            <div class="stat-item">
                <span class="stat-label">Active Devices</span>
                <span class="stat-value" id="stat-devices">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Sensors</span>
                <span class="stat-value" id="stat-sensors">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">High Quality</span>
                <span class="stat-value stat-green" id="stat-high">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Medium Quality</span>
                <span class="stat-value stat-yellow" id="stat-medium">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Low Quality</span>
                <span class="stat-value stat-red" id="stat-low">0</span>
            </div>
        </div>
    </div>

    <!-- Legend Panel -->
    <div id="legend-panel" class="panel legend-panel">
        <h4>Legend</h4>
        <div class="legend-item">
            <span class="legend-marker sensor-marker"></span>
            <span>Sensor</span>
        </div>
        <div class="legend-item">
            <span class="legend-marker device-green"></span>
            <span>High Quality (3+ sensors)</span>
        </div>
        <div class="legend-item">
            <span class="legend-marker device-yellow"></span>
            <span>Medium Quality</span>
        </div>
        <div class="legend-item">
            <span class="legend-marker device-red"></span>
            <span>Low Quality (&lt;3 sensors)</span>
        </div>
        <div class="legend-item">
            <span class="legend-circle debug-circle"></span>
            <span>Distance Circle (Debug)</span>
        </div>
    </div>

    <!-- Device Detail Modal -->
    <div id="device-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Device Details</h3>
                <button id="close-modal" class="btn-icon">
                    <svg class="icon" style="stroke:currentColor;fill:none;stroke-width:2"><use href="#icon-close"/></svg>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Zone Name Modal -->
    <div id="zone-modal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Name Your Zone</h3>
                <button id="close-zone-modal" class="btn-icon">
                    <svg class="icon" style="stroke:currentColor;fill:none;stroke-width:2"><use href="#icon-close"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="zone-name-input" placeholder="e.g., Mensa, Parking 1, Entrance..." class="input-field">
                <div class="modal-buttons">
                    <button id="save-zone-name" class="btn btn-primary">Save Zone</button>
                    <button id="cancel-zone" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GPS Coordinate Input Modal -->
    <div id="gps-modal" class="modal" style="display: none;">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h3>Sensor GPS Coordinates</h3>
            </div>
            <div class="modal-body">
                <p class="gps-modal-info">
                    The loaded JSON file does not contain GPS coordinates.<br>
                    Please enter the coordinates for each sensor:
                </p>
                <div id="sensor-gps-inputs" class="sensor-gps-list">
                    <!-- Dynamically populated -->
                </div>
                <div class="modal-buttons">
                    <button id="save-gps-coords" class="btn btn-primary">Save Coordinates</button>
                    <button id="cancel-gps" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p class="loading-text">Processing data...</p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Paho MQTT Client (WebSocket) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <!-- Application Modules -->
    <script src="js/gpsStorage.js"></script>
    <script src="js/dataHandler.js"></script>
    <script src="js/lateration.js"></script>
    <script src="js/mapLayers.js"></script>
    <script src="js/timeControls.js"></script>
    <script src="js/zoneManager.js"></script>
    <script src="js/uiController.js"></script>
    <script src="js/mqttHandler.js"></script>
    <script src="js/app.js"></script>
</body>

</html>
